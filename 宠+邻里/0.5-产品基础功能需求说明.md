# 宠物生活平台小程序（Demo v1）- 开发需求说明（AI编程可用）

面向 AI 编程工具，提供可直接落地到微信云开发的小程序技术规格。以“宠物寻失与匹配”为主线，覆盖数据模型、页面结构、云函数接口、交互流程与匹配规则，确保可一键生成、部署与运行。

- 微信开发者 AppID：`wx9b6a58e47c67388f`
- 云环境 ID：`cloud1-9gqreqi3bc234646`
- 平台与技术栈：微信小程序（WXML/WXSS/JS）、微信云开发（数据库/存储/云函数/定时触发器）

## 1. 产品概述与范围
- 产品定位：本地化宠物生活服务平台；以交流发帖为主，强化“寻宠/收养”功能流程与匹配体验。
- 目标用户：养猫/狗人士、宠物救助者、潜在领养人。
- Demo v1 范围：
  - 普通交流帖：标题/图片/文本/地点/ + 评论交流。
  - 寻宠功能帖（含“寻宠/发现”）：必填品种、毛色、性别、年龄、地点半径、时间范围、是否有特殊需求；具备有效期，到期不再展示。
  - 收养功能帖（含“发布收养/期望收养”）：同上字段，且具备有效期机制。
  - 基础能力：微信登录授权、个人中心、消息中心（匹配提醒）。
- 关键价值：在本地化场景下对“寻宠/收养”进行自动匹配与提醒，提升找宠与领养效率。

## 2. 项目结构建议
```
root/
 ├─ miniprogram/                # 小程序前端
 │   ├─ app.js|json|wxss
 │   ├─ pages/
 │   │   ├─ index/              # 首页信息流
 │   │   ├─ publish/            # 发布页（普通/寻宠/发现/收养）
 │   │   ├─ detail/             # 帖子详情
 │   │   ├─ profile/            # 个人中心
 │   │   ├─ messages/           # 消息中心
 │   │   ├─ search/             # 搜索页
 │   ├─ components/             # PostCard、ImageCarousel、CommentList 等
 │   └─ utils/                  # 校验、定位、评分算法（前端可选轻量）
 ├─ cloudfunctions/             # 云函数
 │   ├─ auth/                   # 登录鉴权
 │   ├─ posts/                  # 帖子CRUD与列表
 │   ├─ comments/               # 评论CRUD与列表
 │   ├─ search/                 # 搜索
 │   ├─ matcher/                # 匹配计算
 │   ├─ notify/                 # 通知推送入库
 │   └─ cron/                   # 定时任务（过期清理/批量匹配）
 └─ project.config.json         # 配置（appid、云环境、云函数根目录）
```

## 3. 角色与权限
- 游客：可浏览信息流与详情、发起搜索；不可发布与评论。
- 登录用户：可发布、编辑自己的帖子；可评论；可订阅并接收匹配提醒。
- 管理员（可选）：具备内容审核与非法内容删除权限。

## 4. 云开发数据库与数据模型
集合命名与字段如下（示例类型为直观表达，实际以 JSON 为准）：

### 4.1 users（用户）
- `_id`：string
- `openid`：string（唯一）
- `unionid`：string（可选）
- `nickName`、`avatarUrl`、`gender`、`city`、`province`、`country`
- `phoneNumber`：string（可选，用户授权后写入）
- `location`：{ `latitude`: number, `longitude`: number, `address`: string }（可选）
- `createdAt`、`updatedAt`：timestamp

索引：`openid` 唯一索引。

### 4.2 posts（帖子）
- `_id`
- `type`：enum `normal` | `lost` | `found` | `adoption`
- `subType`：enum（仅当 `type=adoption` 时：`offer` | `wanted`）
- `title`、`content`
- `images`：string[]（云存储 fileId 列表）
- `authorId`：string（关联 users._id）
- `breed`、`color`、`sex`：enum `male` | `female` | `unknown`
- `age`：string（如“幼年/成年/老年”或自定义文本）
- `specialNeeds`：string（如“有芯片/疾病史/需长期护理”等）
- `eventDate`：timestamp（寻宠/发现发生时间或收养相关时间）
- `location`：{ `latitude`, `longitude`, `address` }
- `radiusKm`：number（为匹配计算提供半径）
- `expireAt`：timestamp（到期后不展示）
- `status`：enum `active` | `expired` | `deleted`
- `contact`：{ `phone`: string, `wechat`: string }（至少提供一种）
- `createdAt`、`updatedAt`

索引：`type+createdAt`、`expireAt`、`status`、`authorId+createdAt`。

### 4.3 comments（评论）
- `_id`
- `postId`：string（关联 posts._id）
- `authorId`：string（关联 users._id）
- `content`：string；`images`：string[]（可选）
- `createdAt`；`status`：`active` | `deleted`

索引：`postId+createdAt`。

### 4.4 matches（匹配结果）
- `_id`
- `postId`：源帖子（如 `lost`）
- `candidatePostId`：候选帖子（如 `found`）
- `score`：number（0~100）
- `rules`：{ `breed`: number, `color`: number, `sex`: number, `distanceKm`: number, `timeDiffDays`: number }
- `createdAt`
- `notified`：boolean（是否已生成消息提醒）

索引：`postId+score`、`candidatePostId`。

### 4.5 notifications（消息通知）
- `_id`
- `userId`：接收者（关联 users._id）
- `type`：`match` | `system`
- `title`、`content`
- `data`：{ `postId`: string, `candidatePostId`: string, `score`: number }
- `read`：boolean
- `createdAt`

索引：`userId+createdAt`、`read`。

## 5. 页面与交互（前端）
### 5.1 首页信息流（`pages/index`）
- 列表：按时间倒序展示 `lost` 与 `found`（默认显示未过期的帖子）。
- 搜索：支持按 `标题/品种/地点` 搜索；筛选 `type`、距离范围。
- 卡片：缩略图、标题、标签（品种/颜色/性别）、地点、时间、操作入口。

### 5.2 发布页（`pages/publish`）
- 类型选择：`普通交流`、`寻宠`、`发现`、`收养（发布/期望）`。
- 通用字段：标题、图片、文本、地点选择、联系方式。
- 类型特有字段：品种、毛色、性别、年龄、是否特殊需求、发生时间、匹配半径、有效期（如 30/90 天）。
- 校验：必填项校验、图片与文本内容安全校验、联系方式校验。

### 5.3 帖子详情（`pages/detail`）
- 轮播图、完整信息展示。
- 操作：`联系Ta`（电话或复制微信号）、`相似提醒`（订阅消息占位）。
- 评论列表与发布评论。

### 5.4 个人中心（`pages/profile`）
- 我的发布、我的评论、基本资料（头像昵称、电话授权绑定）。

### 5.5 消息中心（`pages/messages`）
- 系统推送的匹配提醒列表；可标记已读。

### 5.6 搜索页（`pages/search`）
- 关键字与筛选条件输入，结果列表展示。

## 6. 云函数与接口定义
统一以 `wx.cloud.callFunction({ name, data })` 调用；所有返回格式：
```
{ code: 0, message: 'OK', data: any }
# 常见错误：
# code=401 (AUTH_REQUIRED), 400 (VALIDATION_ERROR), 404 (NOT_FOUND), 429 (RATE_LIMITED)
```

### 6.1 auth（登录鉴权）
- 入参：`{ action: 'login' }`
- 出参：`{ openid, user: { _id, nickName, avatarUrl } }`（首次登录自动创建 users）

### 6.2 posts（帖子服务）
- `create`：入参为 posts 字段（前端先通过 `wx.cloud.uploadFile` 上传图片得到 fileId）。返回 `_id`。
- `update`：`{ id, patch }`（仅作者可改）。
- `delete`：`{ id }`（逻辑删除，`status=deleted`）。
- `detail`：`{ id }` 返回完整帖子与作者信息、评论统计。
- `list`：`{ type?, keyword?, location?, radiusKm?, page?, pageSize?, sort? }`
- `mine`：`{ page?, pageSize? }` 列出本人发布。

### 6.3 comments（评论服务）
- `create`：`{ postId, content, images? }`
- `list`：`{ postId, page?, pageSize? }`
- `delete`：`{ id }`（作者或管理员）。

### 6.4 search（搜索服务）
- `posts`：`{ keyword, type?, breed?, color?, location?, radiusKm?, page?, pageSize? }`

### 6.5 matcher（匹配服务）
- `runForPost`：`{ postId }` 对单帖运行匹配（如新建 `lost` 后，匹配 `found`）。
- 评分规则（默认权重，可在云函数内常量配置）：
  - 品种匹配：30分
  - 毛色匹配：20分
  - 性别匹配：10分
  - 距离（≤半径）匹配：25分（超出则0）
  - 时间差（≤7天）匹配：15分（超出逐步衰减）
- 返回：`{ matches: [{ candidatePostId, score, rules }] }` 并写入 `matches`，同时投递 `notifications`。

### 6.6 notify（通知服务）
- `push`：`{ userId, title, content, data }` 入库到 `notifications`；可扩展订阅消息（模板ID留空占位）。

### 6.7 cron（定时任务）
- `expirePosts`：每日清理 `expireAt < now` 的帖子，置 `status=expired`。
- `dailyMatch`：对近7日活跃 `lost` 批量匹配一次，写入 `matches/notifications`。

## 7. 交互流程说明
### 7.1 登录
- 前端调用 `auth.login` 获取/创建用户；缓存 `_id/openid`。

### 7.2 发布（以“寻宠”为例）
- 选择类型 `lost` → 填写通用与特有字段 → 图片上传获取 fileId → 调用 `posts.create`。
- 成功后调用 `matcher.runForPost` 进行初次匹配；返回候选与评分。

### 7.3 详情页操作
- `联系Ta`：优先 `wx.makePhoneCall(contact.phone)`；若无电话则复制微信号。
- `相似提醒`：调用 `notify.push` 写入提醒；（订阅消息后续接入）。

### 7.4 消息中心
- 列出 `notifications`；点击跳转相关 `postId/candidatePostId` 详情。

## 8. 内容安全与合规
- 图片与文本调用内容安全（`imgSecCheck`/`msgSecCheck`）拦截违规内容。
- 发布频率限制：默认每用户每日最多 10 条；评论每分钟 5 条。
- 权限校验：仅作者可编辑/删除其帖子；管理员可删除违规内容。

## 9. 索引与性能建议
- 建立 `posts(type, createdAt)`、`posts(expireAt)`、`posts(status)`、`comments(postId, createdAt)`、`notifications(userId, createdAt)` 索引。
- 地理距离计算在 `matcher` 云函数内使用 Haversine 公式；`radiusKm` 作为过滤阈值。

## 10. 配置与部署
- `project.config.json`：配置 `appid=wx9b6a58e47c67388f`，绑定云环境 `cloud1-9gqreqi3bc234646`，`cloudfunctionRoot=cloudfunctions`。
- 开通云开发数据库与存储；创建上述集合；为集合添加索引（如上）。
- 设置定时触发器：每日 02:00 触发 `cron/expirePosts` 与 `cron/dailyMatch`。

## 11. 验收标准（Demo v1）
- 登录可用，首次登录自动建用户。
- 发布普通/寻宠/发现/收养帖子成功；到期自动失效不展示。
- 首页能展示最新 `lost/found`，支持搜索与筛选。
- 详情页可联系与评论；评论顺序正确。
- 新建 `lost` 能得到至少一次匹配计算并生成消息提醒。
- 消息中心能查看并标记已读。

## 12. 示例数据（用于联调）
- 示例“寻宠”帖子：
```
{
  type: "lost",
  title: "寻找一只黑白毛色的英短猫",
  images: ["cloud://.../lost/cat1.jpg"],
  breed: "英短",
  color: "黑白",
  sex: "unknown",
  age: "成年",
  specialNeeds: "有芯片",
  eventDate: 1728000000000,
  location: { latitude: 31.2304, longitude: 121.4737, address: "上海黄浦区" },
  radiusKm: 3,
  expireAt: 1735600000000,
  contact: { phone: "13800000000" }
}
```
- 示例“发现”帖子：
```
{
  type: "found",
  title: "发现一只疑似英短，黑白色",
  images: ["cloud://.../found/cat2.jpg"],
  breed: "英短",
  color: "黑白",
  sex: "unknown",
  eventDate: 1728200000000,
  location: { latitude: 31.2320, longitude: 121.4800, address: "上海静安区" },
  radiusKm: 2,
  expireAt: 1735600000000
}
```

—— 以上规格可直接驱动 AI 编程工具生成微信小程序（基于云开发）的后端云函数、数据库集合、前端页面与交互逻辑。请按此结构搭建项目与代码。