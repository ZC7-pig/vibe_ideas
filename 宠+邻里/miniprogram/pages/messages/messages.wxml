<!--æ¶ˆæ¯é¡µé¢-->
<view class="messages-container">
  <!-- æœªç™»å½•çŠ¶æ€ -->
  <view wx:if="{{!isLoggedIn}}" class="login-prompt">
    <view class="prompt-icon">ğŸ“±</view>
    <view class="prompt-text">è¯·å…ˆç™»å½•æŸ¥çœ‹æ¶ˆæ¯</view>
    <button class="login-btn" bindtap="goToLogin">ç«‹å³ç™»å½•</button>
  </view>

  <!-- å·²ç™»å½•çŠ¶æ€ -->
  <view wx:else>
    <!-- æ¶ˆæ¯ç±»å‹åˆ‡æ¢ -->
    <view class="message-tabs">
      <view 
        class="tab-item {{activeTab === 'system' ? 'active' : ''}}"
        bindtap="switchTab"
        data-tab="system"
      >
        ç³»ç»Ÿæ¶ˆæ¯
        <view wx:if="{{systemUnreadCount > 0}}" class="unread-badge">{{systemUnreadCount}}</view>
      </view>
      <view 
        class="tab-item {{activeTab === 'match' ? 'active' : ''}}"
        bindtap="switchTab"
        data-tab="match"
      >
        åŒ¹é…é€šçŸ¥
        <view wx:if="{{matchUnreadCount > 0}}" class="unread-badge">{{matchUnreadCount}}</view>
      </view>
      <view 
        class="tab-item {{activeTab === 'comment' ? 'active' : ''}}"
        bindtap="switchTab"
        data-tab="comment"
      >
        è¯„è®ºå›å¤
        <view wx:if="{{commentUnreadCount > 0}}" class="unread-badge">{{commentUnreadCount}}</view>
      </view>
    </view>

    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <scroll-view 
      class="messages-list" 
      scroll-y="{{true}}"
      bindscrolltolower="loadMoreMessages"
      refresher-enabled="{{true}}"
      refresher-triggered="{{refreshing}}"
      bindrefresherrefresh="onRefresh"
    >
      <!-- åŠ è½½ä¸­ -->
      <view wx:if="{{loading && messages.length === 0}}" class="loading-container">
        <view class="loading-spinner"></view>
        <view class="loading-text">åŠ è½½ä¸­...</view>
      </view>

      <!-- æ¶ˆæ¯åˆ—è¡¨ -->
      <view wx:elif="{{messages.length > 0}}" class="message-items">
        <view 
          wx:for="{{messages}}" 
          wx:key="id" 
          class="message-item {{!item.isRead ? 'unread' : ''}}"
          bindtap="viewMessage"
          data-message="{{item}}"
        >
          <!-- æ¶ˆæ¯å›¾æ ‡ -->
          <view class="message-icon">
            <view wx:if="{{item.type === 'system'}}" class="icon system-icon">ğŸ””</view>
            <view wx:elif="{{item.type === 'match'}}" class="icon match-icon">ğŸ¯</view>
            <view wx:elif="{{item.type === 'comment'}}" class="icon comment-icon">ğŸ’¬</view>
            <view wx:elif="{{item.type === 'like'}}" class="icon like-icon">â¤ï¸</view>
          </view>

          <!-- æ¶ˆæ¯å†…å®¹ -->
          <view class="message-content">
            <view class="message-title">{{item.title}}</view>
            <view class="message-summary">{{item.content}}</view>
            <view class="message-time">{{item.createTimeFormatted}}</view>
          </view>

          <!-- æœªè¯»æ ‡è¯† -->
          <view wx:if="{{!item.isRead}}" class="unread-dot"></view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view wx:else class="empty-container">
        <view class="empty-icon">ğŸ“­</view>
        <view class="empty-text">æš‚æ— {{tabNames[activeTab]}}æ¶ˆæ¯</view>
      </view>

      <!-- åŠ è½½æ›´å¤š -->
      <view wx:if="{{hasMore && messages.length > 0}}" class="load-more">
        <view wx:if="{{loadingMore}}" class="loading-more">
          <view class="loading-spinner small"></view>
          <text>åŠ è½½ä¸­...</text>
        </view>
        <view wx:else class="load-more-btn" bindtap="loadMoreMessages">
          ç‚¹å‡»åŠ è½½æ›´å¤š
        </view>
      </view>

      <!-- æ²¡æœ‰æ›´å¤š -->
      <view wx:if="{{!hasMore && messages.length > 0}}" class="no-more">
        æ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†
      </view>
    </scroll-view>

    <!-- å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯» -->
    <view wx:if="{{messages.length > 0 && hasUnread}}" class="mark-all-read">
      <button class="mark-read-btn" bindtap="markAllRead">å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»</button>
    </view>
  </view>
</view>

<!-- æ¶ˆæ¯è¯¦æƒ…å¼¹çª— -->
<view wx:if="{{showMessageDetail}}" class="message-modal" bindtap="closeMessageDetail">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <view class="modal-title">{{selectedMessage.title}}</view>
      <view class="modal-close" bindtap="closeMessageDetail">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="message-detail-content">{{selectedMessage.content}}</view>
      <view wx:if="{{selectedMessage.data}}" class="message-data">
        <!-- åŒ¹é…æ¶ˆæ¯çš„é¢å¤–ä¿¡æ¯ -->
        <view wx:if="{{selectedMessage.type === 'match' && selectedMessage.data.matchedPost}}">
          <view class="matched-post">
            <view class="matched-title">åŒ¹é…çš„å¸–å­ï¼š</view>
            <view class="matched-info">
              <view class="matched-post-title">{{selectedMessage.data.matchedPost.title}}</view>
              <view class="matched-post-type">ç±»å‹ï¼š{{selectedMessage.data.matchedPost.typeText}}</view>
            </view>
          </view>
        </view>
        
        <!-- è¯„è®ºæ¶ˆæ¯çš„é¢å¤–ä¿¡æ¯ -->
        <view wx:if="{{selectedMessage.type === 'comment' && selectedMessage.data.post}}">
          <view class="comment-post">
            <view class="comment-title">ç›¸å…³å¸–å­ï¼š</view>
            <view class="comment-info">
              <view class="comment-post-title">{{selectedMessage.data.post.title}}</view>
            </view>
          </view>
        </view>
      </view>
      <view class="message-detail-time">{{selectedMessage.createTimeFormatted}}</view>
    </view>
    <view class="modal-footer">
      <button 
        wx:if="{{selectedMessage.data && selectedMessage.data.postId}}" 
        class="view-post-btn"
        bindtap="viewRelatedPost"
      >
        æŸ¥çœ‹ç›¸å…³å¸–å­
      </button>
      <button class="close-btn" bindtap="closeMessageDetail">å…³é—­</button>
    </view>
  </view>
</view>