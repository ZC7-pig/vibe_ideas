# 宠+邻里小程序部署指南

## 部署前准备

### 1. 账号准备
- [ ] 微信小程序账号（已认证）
- [ ] 微信开发者工具（最新版本）
- [ ] 微信云开发环境

### 2. 环境要求
- Node.js >= 14.0.0
- npm >= 6.0.0
- 微信开发者工具 >= 1.05.0

## 详细部署步骤

### 第一步：项目配置

#### 1.1 下载项目
```bash
# 克隆或下载项目到本地
git clone [项目地址]
cd 宠+邻里
```

#### 1.2 配置小程序信息
编辑 `project.config.json` 文件：
```json
{
  "appid": "你的小程序AppID",
  "projectname": "宠+邻里",
  "cloudfunctionRoot": "cloudfunctions/",
  "setting": {
    "urlCheck": false,
    "es6": true,
    "enhance": true,
    "postcss": true,
    "minified": true
  }
}
```

#### 1.3 配置云开发环境
编辑 `miniprogram/app.js`：
```javascript
wx.cloud.init({
  env: '你的云开发环境ID', // 替换为实际的环境ID
  traceUser: true
});
```

### 第二步：云开发环境设置

#### 2.1 创建云开发环境
1. 登录微信公众平台
2. 进入小程序后台
3. 点击"云开发" -> "开通"
4. 创建环境（建议创建两个环境：开发环境和生产环境）

#### 2.2 配置环境变量
在云开发控制台设置以下环境变量：
```
ENVIRONMENT=production
DEBUG_MODE=false
MAX_UPLOAD_SIZE=10485760  # 10MB
MATCH_THRESHOLD=0.7       # 匹配阈值
NOTIFICATION_BATCH_SIZE=100
```

### 第三步：数据库初始化

#### 3.1 创建数据库集合
在云开发控制台的数据库中，运行初始化脚本：

1. 上传 `database/init.js` 到云函数
2. 在云函数控制台执行初始化脚本
3. 验证所有集合是否创建成功

#### 3.2 设置数据库权限
为每个集合设置适当的读写权限：

**users 集合权限：**
```javascript
// 读权限
{
  "read": "doc._openid == auth.openid || doc.public == true"
}

// 写权限  
{
  "write": "doc._openid == auth.openid"
}
```

**posts 集合权限：**
```javascript
// 读权限
{
  "read": true  // 所有人可读
}

// 写权限
{
  "write": "doc._openid == auth.openid"
}
```

**comments 集合权限：**
```javascript
// 读权限
{
  "read": true
}

// 写权限
{
  "write": "auth.openid != null"  // 登录用户可写
}
```

#### 3.3 创建数据库索引
为提高查询性能，创建以下索引：

**posts 集合索引：**
- `{ "type": 1, "createdAt": -1 }`
- `{ "location.coordinates": "2dsphere" }`
- `{ "authorId": 1, "createdAt": -1 }`
- `{ "status": 1, "createdAt": -1 }`

**comments 集合索引：**
- `{ "postId": 1, "createdAt": -1 }`
- `{ "parentId": 1, "createdAt": -1 }`

**notifications 集合索引：**
- `{ "userId": 1, "createdAt": -1 }`
- `{ "userId": 1, "read": 1 }`

### 第四步：云函数部署

#### 4.1 安装依赖
在微信开发者工具中：
1. 右键点击 `cloudfunctions` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待所有云函数部署完成

#### 4.2 配置云函数权限
在云开发控制台为每个云函数配置适当的权限：

**auth 云函数：**
- 数据库读写权限
- 用户管理权限

**posts 云函数：**
- 数据库读写权限
- 云存储权限

**matcher 云函数：**
- 数据库读写权限
- 定时触发器权限

#### 4.3 设置定时触发器
为 `matcher` 云函数设置定时触发器：
```
触发器名称: auto-match
触发周期: 0 */10 * * * *  # 每10分钟执行一次
```

### 第五步：云存储配置

#### 5.1 设置存储权限
```javascript
// 上传权限
{
  "write": "auth.openid != null"
}

// 下载权限  
{
  "read": true
}
```

#### 5.2 配置CDN加速
1. 在云开发控制台开启CDN加速
2. 配置自定义域名（可选）
3. 设置缓存策略

### 第六步：小程序配置

#### 6.1 配置服务器域名
在小程序后台配置以下域名：
- request合法域名：`https://api.weixin.qq.com`
- uploadFile合法域名：`https://云开发环境ID.tcb.qcloud.la`
- downloadFile合法域名：`https://云开发环境ID.tcb.qcloud.la`

#### 6.2 配置地图服务
1. 申请腾讯地图API密钥
2. 在小程序后台配置地图服务
3. 更新 `utils/location.js` 中的API密钥

#### 6.3 配置消息推送
1. 申请消息模板
2. 配置推送参数
3. 测试消息推送功能

### 第七步：测试验证

#### 7.1 功能测试
运行测试用例验证各功能模块：
```bash
# 在云函数控制台运行
node test/test-cases.js
```

#### 7.2 性能测试
- 测试首页加载时间
- 测试搜索响应速度
- 测试图片上传速度
- 测试并发访问能力

#### 7.3 兼容性测试
在不同设备和微信版本上测试：
- iOS设备测试
- Android设备测试
- 不同微信版本测试

### 第八步：上线发布

#### 8.1 代码审查
- [ ] 代码质量检查
- [ ] 安全性检查
- [ ] 性能优化检查
- [ ] 用户体验检查

#### 8.2 提交审核
1. 在微信开发者工具中点击"上传"
2. 填写版本号和项目备注
3. 在小程序后台提交审核
4. 等待审核结果

#### 8.3 发布上线
审核通过后：
1. 在小程序后台点击"发布"
2. 设置发布时间
3. 监控上线后的运行状态

## 监控和维护

### 1. 性能监控
- 云函数调用量监控
- 数据库读写监控
- 存储使用量监控
- 用户访问量监控

### 2. 错误监控
- 云函数错误日志
- 小程序错误上报
- 用户反馈收集

### 3. 数据备份
- 定期备份数据库
- 备份云存储文件
- 备份云函数代码

### 4. 版本更新
- 制定版本发布计划
- 准备回滚方案
- 用户通知机制

## 常见问题解决

### Q1: 云函数部署失败
**解决方案：**
1. 检查网络连接
2. 确认云开发环境是否正常
3. 检查云函数代码语法
4. 查看详细错误日志

### Q2: 数据库连接失败
**解决方案：**
1. 确认环境ID配置正确
2. 检查数据库权限设置
3. 验证用户登录状态
4. 查看云函数日志

### Q3: 图片上传失败
**解决方案：**
1. 检查文件大小限制
2. 确认存储权限配置
3. 验证文件格式支持
4. 检查网络状况

### Q4: 智能匹配不工作
**解决方案：**
1. 检查定时触发器配置
2. 验证匹配算法逻辑
3. 确认数据格式正确
4. 查看matcher云函数日志

### Q5: 消息推送失败
**解决方案：**
1. 确认模板ID正确
2. 检查用户授权状态
3. 验证推送参数格式
4. 查看推送日志

## 安全注意事项

### 1. 数据安全
- 敏感信息加密存储
- 用户隐私保护
- 数据传输加密
- 定期安全审计

### 2. 接口安全
- 参数验证和过滤
- 防止SQL注入
- 限制请求频率
- 用户权限验证

### 3. 业务安全
- 防止恶意刷单
- 内容审核机制
- 用户行为监控
- 异常操作告警

## 联系支持

如果在部署过程中遇到问题，可以通过以下方式获取帮助：

- 技术文档：[项目Wiki地址]
- 问题反馈：[GitHub Issues地址]
- 技术交流群：[微信群二维码]
- 邮件支持：support@petcommunity.com

---

**部署检查清单**

部署完成后，请确认以下项目都已正确配置：

- [ ] 小程序AppID配置正确
- [ ] 云开发环境创建并配置
- [ ] 数据库集合和索引创建完成
- [ ] 云函数部署成功
- [ ] 云存储权限配置正确
- [ ] 服务器域名配置完成
- [ ] 地图服务配置正确
- [ ] 消息推送配置完成
- [ ] 功能测试通过
- [ ] 性能测试达标
- [ ] 安全检查完成
- [ ] 审核提交成功

祝您部署顺利！🎉