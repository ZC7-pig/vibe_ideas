# 用户数据存储问题排查指南

## 🔍 问题现象
updateUserProfile云函数调用成功，但users集合中没有用户数据

## 📋 排查步骤

### 第一步：重新部署云函数
```bash
# 在项目根目录运行
./deploy-functions.sh
```
**重要**：必须在微信开发者工具中重新上传并部署以下云函数：
- `updateUserProfile` (包含最新的调试日志)
- `testDatabasePermission` (新增的权限测试函数)

### 第二步：检查数据库集合和权限
1. 打开微信开发者工具
2. 点击"云开发" -> "数据库"
3. 确认以下集合存在：
   - ✅ `users`
   - ✅ `posts` 
   - ✅ `notifications`

4. 检查`users`集合权限设置：
   - 点击`users`集合
   - 查看"权限设置"
   - **开发阶段建议设置**：
     - 读权限：`true`
     - 写权限：`true`

### 第三步：使用测试工具诊断
1. 在小程序中进入"个人中心"
2. 点击"🧪 测试用户存储"
3. **按顺序执行测试**：

#### 3.1 测试数据库权限
- 点击"测试数据库权限"按钮
- 这会调用专门的权限测试云函数
- 检查是否能正常读写数据库

#### 3.2 测试数据库集合
- 点击"测试数据库集合"按钮
- 验证所有必要集合是否存在

#### 3.3 测试完整登录流程
- 点击"测试完整登录流程"按钮
- 观察详细的执行日志

### 第四步：查看云函数日志
1. 在微信开发者工具中点击"云开发"
2. 进入"云函数"标签页
3. 点击`updateUserProfile`云函数
4. 查看"日志"标签页
5. 寻找以下关键信息：
   - `=== updateUserProfile 开始执行 ===`
   - `准备写入的用户数据:`
   - `新用户创建成功:` 或 `用户信息更新成功:`
   - `创建后验证查询结果:`

## 🚨 常见问题和解决方案

### 问题1：权限不足
**现象**：云函数日志显示权限相关错误
**解决**：
1. 检查数据库集合权限设置
2. 确保设置为"所有用户可读写"（开发阶段）

### 问题2：环境ID不匹配
**现象**：云函数调用成功但数据写入失败
**解决**：
1. 检查`app.js`中的环境ID：`env: 'cloud1-9gqreqi3bc234646'`
2. 检查所有云函数的环境ID是否一致

### 问题3：云函数未部署最新版本
**现象**：修改后的日志没有出现
**解决**：
1. 重新上传并部署云函数
2. 确保选择"云端安装依赖"

### 问题4：数据库集合不存在
**现象**：访问集合时报错
**解决**：
1. 在云开发控制台手动创建`users`集合
2. 设置正确的权限

## 📊 预期的正常日志
```
=== updateUserProfile 开始执行 ===
接收到的事件数据: {avatarUrl: "...", nickName: "..."}
用户OpenID: oXxxxxxxxxxxxxx
准备写入的用户数据: {_openid: "oXxxxxxxxxxxxxx", ...}
用户不存在，创建新用户: oXxxxxxxxxxxxxx
准备创建新用户，数据: {_openid: "oXxxxxxxxxxxxxx", ...}
新用户创建成功: oXxxxxxxxxxxxxx {_id: "oXxxxxxxxxxxxxx"}
创建后验证查询结果: {data: {...}}
=== updateUserProfile 执行完成 ===
```

## 🔧 如果问题仍然存在
1. 截图云函数日志的详细信息
2. 截图数据库权限设置
3. 提供测试工具的完整输出结果

这些信息将帮助进一步定位问题根源。