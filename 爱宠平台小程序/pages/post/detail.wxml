<!--pages/post/detail.wxml-->
<view class="page-container" wx:if="{{post}}">
  <!-- 图片轮播 -->
  <view class="image-container" wx:if="{{post.images.length > 0}}">
    <swiper class="image-swiper" indicator-dots="{{post.images.length > 1}}" autoplay="false">
      <swiper-item wx:for="{{post.images}}" wx:key="index">
        <image 
          class="detail-image" 
          src="{{item}}" 
          mode="aspectFill"
          bindtap="onImageTap"
          data-index="{{index}}"
        ></image>
      </swiper-item>
    </swiper>
    <view class="image-indicator" wx:if="{{post.images.length > 1}}">
      {{currentImageIndex + 1}}/{{post.images.length}}
    </view>
  </view>

  <!-- 帖子信息 -->
  <view class="post-info">
    <!-- 标题和类型 -->
    <view class="post-header">
      <text class="post-title">{{post.title}}</text>
      <view class="post-type-tag {{post.type}}">{{post.typeText}}</view>
    </view>

    <!-- 基本信息 -->
    <view class="info-section">
      <view class="info-item">
        <text class="info-label">品种</text>
        <text class="info-value">{{post.breed}}</text>
      </view>
      <view class="info-item">
        <text class="info-label">毛色</text>
        <text class="info-value">{{post.color}}</text>
      </view>
      <view class="info-item">
        <text class="info-label">地点</text>
        <text class="info-value">{{post.location.name}}</text>
      </view>
      <view class="info-item" wx:if="{{post.lostOrFoundTime}}">
        <text class="info-label">{{post.type === 'lost' ? '丢失' : '发现'}}时间</text>
        <text class="info-value">{{post.lostOrFoundTimeText}}</text>
      </view>
      <view class="info-item" wx:if="{{post.serviceMeta}}">
        <text class="info-label">服务类型</text>
        <text class="info-value">{{post.serviceMeta.modeText}}</text>
      </view>
      <view class="info-item" wx:if="{{post.serviceMeta && post.serviceMeta.price}}">
        <text class="info-label">价格/报酬</text>
        <text class="info-value">{{post.serviceMeta.price}}元</text>
      </view>
      <view class="info-item" wx:if="{{post.adoptStatus}}">
        <text class="info-label">状态</text>
        <text class="info-value">{{post.adoptStatusText}}</text>
      </view>
    </view>

    <!-- 详细描述 -->
    <view class="description-section">
      <text class="section-title">详细描述</text>
      <text class="description-text">{{post.description}}</text>
    </view>

    <!-- 发布者信息 -->
    <view class="publisher-section" wx:if="{{post.userInfo}}">
      <view class="publisher-info">
        <image class="publisher-avatar" src="{{post.userInfo.avatarUrl}}" mode="aspectFill"></image>
        <view class="publisher-details">
          <text class="publisher-name">{{post.userInfo.nickName}}</text>
          <text class="publish-time">{{post.createTimeText}}</text>
        </view>
      </view>
    </view>

    <!-- 编辑时间脚注 -->
    <view class="edit-footer" wx:if="{{post.updateTime}}">
      <text class="edit-info">编辑于{{post.updateDateText}} {{post.updateIP || '未知'}}</text>
    </view>

    <!-- 相似提醒 -->
    <view class="similar-section" wx:if="{{(post.type === 'lost' || post.type === 'found') && similarPosts.length > 0}}">
      <text class="section-title">相似信息</text>
      <view class="similar-list">
        <view class="similar-item" 
              wx:for="{{similarPosts}}" 
              wx:key="_id"
              bindtap="onSimilarPostTap"
              data-id="{{item._id}}">
          <image class="similar-image" src="{{item.images[0]}}" mode="aspectFill"></image>
          <view class="similar-info">
            <text class="similar-title">{{item.title}}</text>
            <text class="similar-meta">{{item.breed}} · {{item.location.name}}</text>
            <text class="similar-score">匹配度: {{item.matchScore}}%</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 操作栏 -->
  <view class="action-bar">
    <view class="action-left">
      <button class="action-btn secondary" bindtap="onShareTap">
        <icon type="download" size="16"></icon>
        <text>分享</text>
      </button>
      <button class="action-btn secondary" bindtap="onSimilarTap" wx:if="{{post.type === 'lost' || post.type === 'found'}}">
        <icon type="search" size="16"></icon>
        <text>相似提醒</text>
      </button>
    </view>
    <view class="action-center" wx:if="{{isOwner}}">
      <button class="action-btn edit" bindtap="onEditTap">
        <icon type="compose" size="16"></icon>
        <text>编辑</text>
      </button>
      <button class="action-btn delete" bindtap="onDeleteTap">
        <icon type="cancel" size="16"></icon>
        <text>删除</text>
      </button>
    </view>
    <view class="action-right">
      <button class="action-btn primary" bindtap="onContactTap">
        <icon type="chat" size="16"></icon>
        <text>联系Ta</text>
      </button>
    </view>
  </view>

  <!-- 联系方式弹窗 -->
  <view class="contact-modal" wx:if="{{showContactModal}}" bindtap="onCloseContactModal">
    <view class="contact-content" catchtap="stopPropagation">
      <view class="contact-header">
        <text class="contact-title">联系方式</text>
        <icon class="contact-close" type="cancel" size="20" bindtap="onCloseContactModal"></icon>
      </view>
      <view class="contact-info">
        <text class="contact-text">{{post.contact}}</text>
        <button class="copy-btn" bindtap="onCopyContact" data-text="{{post.contact}}">复制</button>
      </view>
      <view class="contact-tips">
        <text>请通过以上方式联系发布者</text>
      </view>
    </view>
  </view>
</view>

<!-- 加载状态 -->
<view class="loading-container" wx:else>
  <view class="loading">
    <text>加载中...</text>
  </view>
</view>