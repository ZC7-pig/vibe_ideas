# 宠物生活平台小程序（Demo v1）- 开发就绪产品规格说明

本说明文档融合两份初版需求（DeepSeek 与豆包），以“宠物寻失与匹配”为主线，明确数据模型、页面结构、接口与云函数、交互流程与匹配规则，确保大模型能够直接据此生成可运行的微信小程序代码（基于微信云开发）。

## 1. 产品概述

- 产品定位：面向本地养宠用户的生活服务平台，聚焦“宠物寻失/发现”信息的高效匹配与提醒，同时覆盖寄养、配种、流浪动物收养与本地宠物服务入口。
- 目标用户：养猫/狗人士、宠物救助者、潜在领养人、宠物服务提供者（个人或商家）。
- Demo v1 范围：
  - 核心主线：寻宠/发现信息发布、规则匹配、双向提醒、详情联系
  - 扩展模块：寄养/配种发布与浏览、收养列表与申请
  - 占位模块：本地宠物服务入口（活动/医院/殡葬，仅展示“即将上线”）
  - 基础能力：用户登录（微信授权）、图片上传、定位、个人中心、简易消息中心
- 关键价值：提升寻回效率（规则匹配）、聚焦同城（地理半径）、操作简单（自由文本为主）、可信连接（联系方式、提醒机制）

## 2. 主线核心功能

- 首页信息流：按时间倒序展示“寻宠”和“发现”帖子，支持搜索（标题/品种/地点）。
- 发布页：支持发布“寻宠/发现/寄养/配种/收养/活动/服务”等类型；以“标题+图片+自由文本+地点+联系方式”为主，类型特有字段按需扩展。
- 帖子详情：图片轮播、信息展示、操作按钮（联系Ta、相似提醒）。
- 匹配提醒：基于品种关键词、毛色关键词、地理位置半径与时间范围进行规则匹配，向匹配双方推送提醒，进入消息中心与详情页。
- 个人中心：我的发布、我的提醒（消息中心）、基本资料。
- 消息中心：查看系统推送的匹配提醒；后续可扩展用户间聊天。

## 3. 信息架构与数据模型

集合（Collections）命名建议：`users`, `posts`, `notifications`, `messages`（如需要），`adoptions`（可选）

### 3.1 User（用户）

- 字段
  - `_id`: `ObjectId`（云开发自动生成）
  - `_openid`: `String`（微信 OpenID）
  - `avatarUrl`: `String`
  - `nickName`: `String`
  - `phoneNumber`: `String`（可选）
  - `createTime`: `Date`
- 索引
  - `_openid` 唯一索引
  - `createTime` 倒序查询索引

### 3.2 Post（帖子）

- 字段
  - `_id`: `ObjectId`
  - `userId`: `String`（OpenID）
  - `type`: `String`（`lost` | `found` | `foster` | `breed` | `adopt` | `service` | `activity`）
  - `title`: `String`
  - `images`: `String[]`（图片URL）
  - `breed`: `String`（品种，自由文本；推荐常见品种词表）
  - `color`: `String`（毛色，自由文本；推荐常见颜色词表）
  - `location`: `Object`（`{ name: String, lat: Number, lng: Number }`）
  - `description`: `String`
  - `contact`: `String`（手机号或微信号等）
  - `lostOrFoundTime`: `Date`（仅寻宠/发现）
  - `serviceMeta`: `Object`（寄养/配种等的扩展字段，如 `mode`, `price`, `timeRange`）
  - `adoptStatus`: `String`（收养状态：`pending` | `adopted`）
  - `createTime`: `Date`
  - `updateTime`: `Date`
- 索引
  - `type` + `createTime` 组合索引（信息流）
  - 位置索引：基于 `lat/lng` 的近邻查询（云开发中可用地理索引或前端半径过滤）
  - 文本索引：`title`, `breed`, `color`, `description`（用于搜索）

### 3.3 Notification（提醒）

- 字段
  - `_id`: `ObjectId`
  - `userId`: `String`（接收者 OpenID）
  - `postId`: `String`（当前用户的帖子ID）
  - `matchedPostId`: `String`（匹配到的另一条帖子ID）
  - `message`: `String`（如“您寻找的金毛与[朝阳公园附近发现的金毛]高度相似”）
  - `isRead`: `Boolean`
  - `score`: `Number`（匹配评分，0–100）
  - `createTime`: `Date`
- 索引
  - `userId` + `createTime` 倒序
  - `isRead` 过滤索引

### 3.4 Message（消息）（可选，初版简化为系统提醒）

- 字段
  - `_id`, `fromUserId`, `toUserId`, `postId`, `content`, `createTime`, `isRead`
- 初版可仅使用 `notifications` 实现系统提醒；用户间聊天后续迭代再加。

## 4. 前端结构与页面路由（微信小程序）

建议 `app.json`：

```json
{
  "pages": [
    "pages/home/index",
    "pages/post/create",
    "pages/post/list",
    "pages/post/detail",
    "pages/profile/index",
    "pages/notifications/index",
    "pages/adoption/list",
    "pages/services/index"
  ],
  "window": {
    "navigationBarTitleText": "宠物邻里",
    "navigationStyle": "default"
  },
  "tabBar": {
    "list": [
      { "pagePath": "pages/home/index", "text": "首页", "iconPath": "assets/home.png", "selectedIconPath": "assets/home_active.png" },
      { "pagePath": "pages/post/create", "text": "发布", "iconPath": "assets/add.png", "selectedIconPath": "assets/add_active.png" },
      { "pagePath": "pages/profile/index", "text": "我的", "iconPath": "assets/me.png", "selectedIconPath": "assets/me_active.png" }
    ],
    "color": "#666",
    "selectedColor": "#FF8C00",
    "backgroundColor": "#ffffff"
  },
  "permission": {
    "scope.userLocation": { "desc": "用于展示附近信息与匹配半径计算" }
  },
  "sitemapLocation": "sitemap.json"
}
```

组件建议：
- 通用：`components/ImageUploader`, `components/LocationPicker`, `components/PostCard`, `components/EmptyState`, `components/ConfirmDialog`
- 样式：主色 `#FF8C00`（暖橙），辅色 `#4DB6FF`（清新蓝）

## 5. 页面功能说明

- 首页（`pages/home/index`）
  - 搜索：标题/品种/地点关键词
  - 信息流：展示 `type in [lost, found]`，按 `createTime` 倒序，卡片含图、标题、品种、地点、发布时间
- 发布页（`pages/post/create`）
  - 类型选择：`lost/found/foster/breed/adopt/activity/service`
  - 通用字段：标题、图片（最多9）、品种、毛色、地点（授权+手动调整）、描述、联系方式
  - 特有字段：
    - `lost/found`: 丢失/发现时间
    - `foster/breed`: 服务类型（提供/寻求）、价格/报酬、时间/要求
    - `adopt`: 领养状态（待领养/已领养）
    - `activity/service`: 活动时间/服务地址或展示“即将上线”
- 帖子详情（`pages/post/detail`）
  - 轮播图、信息展示
  - 操作区：`联系Ta`（显示联系方式）、`相似提醒`（触发匹配或展示已匹配列表）
- 个人中心（`pages/profile/index`）
  - 头像昵称（微信授权）、我的发布、我的提醒、关于我们
- 消息中心（`pages/notifications/index`）
  - 系统提醒列表（倒序）、查看跳转到详情、标记已读
- 收养列表（`pages/adoption/list`）
  - 展示待领养信息（照片、健康状况、性格描述），提交基本申请（初版可收集意向）
- 本地服务入口（`pages/services/index`）
  - 三大分类图标（活动/医院/殡葬），点击提示“该功能即将上线，敬请期待”

## 6. 交互流程（主线）

- 寻宠与匹配流程
  1. 用户A发布“寻宠”（含品种/毛色/地点/时间）。
  2. 用户B发布“发现”（含品种/毛色/地点/时间）。
  3. 后端匹配规则（发布时触发 + 定时任务轮询）：
     - 品种关键词匹配（模糊）
     - 毛色关键词匹配（相似词映射）
     - 地理半径内（默认5公里）
     - 时间范围优先（默认近7天）
  4. 当条件满足，向A与B推送提醒到“消息中心”，并附匹配评分与文案。
  5. 用户点击提醒进入详情页进行联系。

- 寄养与配种
  - 发布卡片信息，列表浏览与筛选（时间/距离），后续可拓展聊天。

- 流浪收养
  - 浏览待领养信息，提交申请（收集基本资料），线下对接（初版不实现复杂审核）。

## 7. 匹配规则（Demo版）

- 维度与权重（建议）
  - 品种关键词匹配：基础分 40（完全匹配加权到 50）
  - 毛色关键词匹配：基础分 30（相似色 20）
  - 地理位置半径：基础分 20（5km 内满分）
  - 时间范围：基础分 10（近7天满分）
- 颜色相似词表（示例）
  - 金色 ≈ 浅金色/黄色/浅黄色
  - 黑色 ≈ 深灰/黑灰
  - 白色 ≈ 乳白/米白
- 匹配触发
  - 即时触发：新帖发布后调用匹配云函数
  - 定时任务：每15分钟扫描最近7天的 `lost/found` 进行双向匹配
- 阈值
  - `score >= 70` 触发提醒（可根据运营反馈调整）
- 文案模板
  - `您寻找的{breed}与[{location}发现的{breed}]高度相似（评分{score}），快去看看吧！`

## 8. 接口与云函数规范（微信云开发）

基于微信云开发（云函数 + 云数据库 + 云存储），前端通过 `wx.cloud.callFunction` 或 `wx.cloud.database` 访问。

- 云函数命名建议
  - `createPost`：发布帖子（含图片上传URL写入）
  - `listPosts`：分页列表（支持类型、搜索、距离过滤）
  - `getPostDetail`：详情获取
  - `matchPosts`：规则匹配（即时与定时）
  - `pushNotification`：推送提醒到 `notifications`
  - `listNotifications`：提醒列表
  - `markNotificationRead`：标记已读
  - `getUserProfile` / `updateUserProfile`：用户资料管理

- 请求与响应示例

创建帖子：
```json
// callFunction name: createPost
{
  "type": "lost",
  "title": "寻金毛犬",
  "images": ["cloud://.../img1.jpg"],
  "breed": "金毛",
  "color": "金色",
  "location": { "name": "北京朝阳公园", "lat": 39.94, "lng": 116.43 },
  "description": "丢失时间早上8点，性格温顺",
  "contact": "138****8888",
  "lostOrFoundTime": "2025-10-01T08:00:00Z"
}
```

响应：
```json
{
  "ok": true,
  "data": { "_id": "POST_ID", "createTime": "2025-10-01T09:00:00Z" }
}
```

列表查询：
```json
// callFunction name: listPosts
{
  "type": ["lost", "found"],
  "search": "金毛 朝阳",
  "page": 1,
  "pageSize": 20,
  "center": { "lat": 39.94, "lng": 116.43 },
  "radiusKm": 5
}
```

详情：
```json
// callFunction name: getPostDetail
{ "postId": "POST_ID" }
```

匹配：
```json
// callFunction name: matchPosts
{
  "postId": "POST_ID",           // 新发布帖即时匹配
  "mode": "realtime"             // 或 "batch" 用于定时任务
}
```

推送提醒：
```json
// callFunction name: pushNotification
{
  "userId": "OPENID_A",
  "postId": "POST_A",
  "matchedPostId": "POST_B",
  "message": "您寻找的金毛与[朝阳公园附近发现的金毛]高度相似",
  "score": 85
}
```

提醒列表与标记已读：
```json
// listNotifications
{ "page": 1, "pageSize": 50 }
// markNotificationRead
{ "notificationId": "NOTIF_ID" }
```

## 9. 数据与索引设计要点

- `posts`：建议建立复合索引
  - `type + createTime`（倒序）
  - 文本索引：`title, breed, color, description`
  - 地理索引：若云数据库不支持原生地理索引，可存 `lat/lng` 并在云函数中进行半径过滤
- `notifications`：`userId + createTime` 倒序、`isRead` 过滤

## 10. 权限与安全

- 登录：使用微信授权，读取 `_openid`、`avatarUrl`、`nickName`
- 图片：上传到云存储（按用户隔离目录），仅用于帖子展示
- 地理位置信息：展示名称为主，坐标仅用于匹配计算与距离筛选
- 隐私：联系方式仅在详情页点击后显示；敏感词过滤（可在 `createPost` 中做简单过滤）

## 11. 状态与错误处理

- 状态
  - 帖子类型：`lost/found/foster/breed/adopt/service/activity`
  - 领养状态：`pending/adopted`
  - 提醒已读：`true/false`
- 错误
  - 图片上传失败、定位授权失败、云函数调用异常，需统一 Toast 或对话框反馈
  - 表单校验：必填项（标题、图片至少1张、地点、联系方式）

## 12. 非功能性要求（Demo）

- 性能：列表分页20条，图片缩略展示，进入详情再加载大图
- 可靠性：云函数失败重试1次；提醒推送冪等（相同 `postId+matchedPostId` 不重复）
- 可运维：定时任务间隔15分钟；匹配阈值与半径可配置（3–20公里）

## 13. 目录结构建议

```
project-root/
├── app.js
├── app.json
├── app.wxss
├── assets/
├── components/
│   ├── ImageUploader/
│   ├── LocationPicker/
│   ├── PostCard/
├── pages/
│   ├── home/
│   │   └── index.{wxml,wxss,js,json}
│   ├── post/
│   │   ├── create.{wxml,wxss,js,json}
│   │   ├── list.{wxml,wxss,js,json}
│   │   └── detail.{wxml,wxss,js,json}
│   ├── profile/
│   │   └── index.{wxml,wxss,js,json}
│   ├── notifications/
│   │   └── index.{wxml,wxss,js,json}
│   ├── adoption/
│   │   └── list.{wxml,wxss,js,json}
│   └── services/
│       └── index.{wxml,wxss,js,json}
├── cloudfunctions/
│   ├── createPost/
│   ├── listPosts/
│   ├── getPostDetail/
│   ├── matchPosts/
│   ├── pushNotification/
│   ├── listNotifications/
│   └── markNotificationRead/
└── sitemap.json
```

## 14. 常量与词表建议（可前端维护）

- 常见品种（示例）：金毛、哈士奇、拉布拉多、泰迪、英短、美短、布偶、中华田园犬等
- 常见毛色（示例）：金色、浅金色、黑色、深灰、白色、米白、黄白相间
- 配置常量（`config.js`）
  - `DEFAULT_RADIUS_KM = 5`
  - `MATCH_SCORE_THRESHOLD = 70`
  - `MATCH_RECENT_DAYS = 7`
  - `CRON_MATCH_INTERVAL_MIN = 15`

## 15. 测试用例（验收标准）

- 发布流程
  - 创建“寻宠”成功；字段完整；图片上传成功；定位显示正确
- 列表与搜索
  - 首页能展示“寻宠/发现”；搜索“金毛 朝阳”命中相关帖子
- 匹配与提醒
  - 在近5公里、同品种、相似毛色条件下，发布后 1 分钟内收到提醒；提醒内容正确；点击跳转详情
- 详情与联系
  - 详情展示完整信息；点击“联系Ta”显示联系方式
- 个人中心与提醒
  - “我的发布”正确；“我的提醒”列表倒序，能标记已读
- 占位入口
  - 本地服务页点击提示“功能即将上线”

## 16. 里程碑与交付

- 里程碑A（前端框架与基础页）
  - 完成 `app.json` 路由与 tabBar
  - 完成首页、发布页、详情页基本UI
- 里程碑B（云数据库与云函数）
  - 建立集合与索引；实现 `createPost/listPosts/getPostDetail`
- 里程碑C（匹配与提醒）
  - 实现 `matchPosts/pushNotification/listNotifications/markNotificationRead`
  - 配置定时任务（15分钟）
- 里程碑D（扩展模块）
  - 收养列表与申请；本地服务入口占位
- 交付标准
  - Demo 可在微信开发者工具运行；核心主线流程打通；测试用例通过

---

此规格已对齐两份初版需求，并以“寻宠/发现匹配与提醒”为主线组织信息架构与实现细节。大模型可据此直接生成微信小程序与云函数代码，实现一个可运行的 Demo v1。